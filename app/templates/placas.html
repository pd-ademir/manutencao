{% extends 'base.html' %}

{% block titulo %}Painel de Ve√≠culos{% endblock %}

{% block conteudo %}
<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>Painel de Ve√≠culos</h1>
      {% if tem_permissao(current_user.tipo, 'editar_km') %}
        <a href="{{ url_for('main.atualizar_km_massa') }}"
        style="
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 10px 18px;
          background-color: #007bff;
          color: white;
          font-weight: 500;
          font-size: 16px;
          border: none;
          border-radius: 8px;
          text-decoration: none;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
          transition: background-color 0.3s ease;
        "
        onmouseover="this.style.backgroundColor='#0056b3'"
        onmouseout="this.style.backgroundColor='#007bff'"
        title="Importar arquivo CSV para atualizar KM dos ve√≠culos">
        <i class="fas fa-file-upload" style="font-size: 18px;"></i>
        Atualizar KM em Massa
      </a>

      {% endif %}
    </div>


    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message|safe }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}


  {% for unidade, veiculos in unidades.items() %}
 
    <div class="unidade">
      <h2>Unidade: {{ unidade }}</h2>
      
      <div class="tabela-scroll">
        <table class="tabela-index">
          <thead>
            <tr>
              <th>Motorista</th>
              <th>Placa Cavalo</th>
              <th>Engate 1</th>
              <th>Engate 2</th>
              <th>Modelo</th>
              <th>Fabricante</th>
              <th>Ano</th>
              <th>KM Atual</th>
              <th>Pr√≥x. Preventiva</th>
              <th>Pr√≥x. Intermedi√°ria</th>
              <th>Pr√≥x. Diferencial</th>
              <th>Pr√≥x. C√¢mbio</th>
              <th>Pr√≥x. Calibragem</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
      {% for v in veiculos %}
        {% set vencido = (
          (v.km_para_preventiva is not none and v.km_para_preventiva < 0) or
          (v.km_para_intermediaria is not none and v.km_para_intermediaria < 0) or
          (v.km_para_diferencial is not none and v.km_para_diferencial < 0) or
          (v.km_para_cambio is not none and v.km_para_cambio < 0) or
          (v.data_proxima_calibragem and v.data_proxima_calibragem <= current_date)
        ) %}
        <tr class="{{ 'alerta' if vencido else '' }}">
          <td>{{ v.motorista }}</td>
          <td>
            <a href="{{ url_for('checklist.por_placa', placa=v.placa) }}"
              class="text-decoration-none link-primary">
              {{ v.placa }}
            </a>
          </td>
          <td>{{ v.placa_1 or '-' }}</td>
          <td>{{ v.placa_2 or '-' }}</td>
          <td>{{ v.modelo }}</td>
          <td>{{ v.fabricante }}</td>
          <td>{{ v.ano }}</td>

          <td>
              {% if tem_permissao(current_user.tipo, 'editar_km') %}
              <form action="{{ url_for('main.atualizar_km', id=v.id) }}" method="POST" style="display: flex; gap: 6px; align-items-center;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <input type="number" name="km_atual" value="{{ v.km_atual }}" class="form-control" style="min-width: 120px;" required>
                
                <button type="submit" title="Atualizar KM" style="background: #28a745; border: none; color: white; padding: 3px 8px; border-radius: 4px;">‚úîÔ∏è</button>
              </form>
              {% else %}
                <span class="text-muted">{{ v.km_atual | format_km }}</span>
              {% endif %}
            </td>

          <td>
            {% if v.km_para_preventiva is not none %}
              {% if v.km_para_preventiva < 0 %}
                <span class="vencida">VENCIDA ({{ v.km_para_preventiva | format_km }})</span>
              {% else %}
                {{ v.km_para_preventiva | format_km }}
              {% endif %}
            {% else %}-{% endif %}
          </td>

          <td>
            {% if v.km_para_intermediaria is not none %}
              {% if v.km_para_intermediaria < 0 %}
                <span class="vencida">VENCIDA ({{ v.km_para_intermediaria | format_km }})</span>
              {% else %}
                {{ v.km_para_intermediaria | format_km }}
              {% endif %}
            {% else %}-{% endif %}
          </td>

          <td>
            {% if v.km_para_diferencial is not none %}
              {% if v.km_para_diferencial < 0 %}
                <span class="vencida">VENCIDA ({{ v.km_para_diferencial | format_km }})</span>
              {% else %}
                {{ v.km_para_diferencial | format_km }}
              {% endif %}
            {% else %}-{% endif %}
          </td>

          <td>
            {% if v.km_para_cambio is not none %}
              {% if v.km_para_cambio < 0 %}
                <span class="vencida">VENCIDA ({{ v.km_para_cambio | format_km }})</span>
              {% else %}
                {{ v.km_para_cambio | format_km }}
              {% endif %}
            {% else %}-{% endif %}
          </td>

           <td>
            {% if v.data_proxima_calibragem %}
              {% if v.data_proxima_calibragem <= current_date %}
                <span class="vencida">VENCIDA ({{ v.data_proxima_calibragem.strftime('%d/%m/%Y') }})</span>
              <!--<h2>Unidade: {{ unidade }}</h2> -->
              {% endif %}
            {% else %}-{% endif %}
          </td>
         

          <td>
            {% if tem_permissao(current_user.tipo, 'alterar_dados') %}
              <a href="{{ url_for('main.cadastro_veiculo', id=v.id) }}" class="btn-azul" title="Editar">‚úèÔ∏è</a>
              {% if current_user.tipo == 'master' %}
              <a href="{{ url_for('main.excluir_veiculo', id=v.id) }}" class="btn-vermelho" title="Excluir" onclick="return confirm('Deseja excluir {{ v.placa }}?')">üóëÔ∏è</a>
              {% endif %}
            {% else %}
              <span class="text-muted">Somente leitura</span>
            {% endif %}
          </td>
        </tr>
      
    {% endfor %}
  </tbody>
      </table>
    </div> 
  </div>
 
  {% endfor %}

</div>

<!-- Estilo para a tabela rolar horizontalmente -->
<style>
  .tabela-scroll {
    overflow-x: auto;
  }
</style>


{% endblock %}
