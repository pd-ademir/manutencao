{% extends 'base.html' %}
{% block titulo %}Painel de Manuten√ß√£o{% endblock %}

{% block conteudo %}
<h1>Painel de Manuten√ß√£o</h1>
<!--
<input type="hidden" id="csrf_token" value="{{ csrf_token() }}">
<form method="get" action="{{ url_for('main.index') }}">
  {% if request.args.get('filtro') == 'ocultar_somente_calibragem' %}
    <button class="btn btn-secondary" style="margin-bottom: 15px;">
      üîÑ Mostrar todos os ve√≠culos
    </button>
  {% else %}
    <input type="hidden" name="filtro" value="ocultar_somente_calibragem">
    <button class="btn btn-secondary" style="margin-bottom: 15px;">
      üö´ Ocultar ve√≠culos com apenas calibragem vencida
    </button>
  {% endif %}
</form> -->

{% if current_user.is_authenticated and current_user.tipo.upper() == 'MASTER' %}
  <form action="{{ url_for('main.teste_alerta') }}" method="get">
    <button class="btn btn-danger" style="margin-bottom: 15px; background: #28a745">
      üîî Disparar Alertas de Manuten√ß√£o
    </button>
  </form>
{% endif %}

<p>Confira abaixo os ve√≠culos com revis√µes pr√≥ximas do vencimento.</p>

<div class="tabela-scroll">
  <table class="tabela-index">
    <thead>
      <tr>
        <th>Placa Cavalo</th>
        <th>Engate 1</th>
        <th>Engate 2</th>
        <th>Motorista</th>
        <th>Modelo</th>
        <th>KM Atual</th>
        <th>Pr√≥x. Preventiva</th>
        <th>Pr√≥x. Intermedi√°ria</th>
        <th>Pr√≥x. Diferencial</th>
        <th>Pr√≥x. C√¢mbio</th>
       <!-- <th>Pr√≥x. Calibragem</th>-->
        <th>Unidade</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody>
      {% for veiculo in veiculos %}
        <tr data-placa="{{ veiculo.placa }}" class="{% if veiculo.em_manutencao %}linha-manutencao{% endif %}">
          <td>
            {% if veiculo.data_proxima_revisao_carreta %}
              {% set dias_para_revisao = (veiculo.data_proxima_revisao_carreta - current_date).days %}
              {% if dias_para_revisao < 0 %}
                <span class="badge bg-danger" title="Revis√£o atrasada em {{ -dias_para_revisao }} dias">üî¥</span>
              {% elif dias_para_revisao <= 30 %}
                <span class="badge bg-warning text-dark" title="Revis√£o em {{ dias_para_revisao }} dias">üü°</span>
              {% endif %}
            {% endif %}
            <a href="{{ url_for('checklist.por_placa', placa=veiculo.placa) }}"
              class="link-primary text-decoration-none"
              title="Pr√≥xima revis√£o da carreta: {{ veiculo.data_proxima_revisao_carreta.strftime('%d/%m/%Y') if veiculo.data_proxima_revisao_carreta else 'Sem previs√£o' }}">
              {{ veiculo.placa }}
            </a>
          </td>
          <td>{{ veiculo.placa_1 or '-' }}</td>
          <td>{{ veiculo.placa_2 or '-' }}</td>
          <td>{{ veiculo.motorista }}</td>
          <td>{{ veiculo.modelo }}</td>
          <td title="Atualizado em: {{ veiculo.data_ultima_atualizacao_km.strftime('%d/%m/%Y %H:%M') if veiculo.data_ultima_atualizacao_km else 'Sem registro' }}">
            {{ veiculo.km_atual | format_km }}
          </td>
          <td class="{% if veiculo.km_para_preventiva is not none and veiculo.km_para_preventiva <= 5000 %}alerta{% endif %}">
            {{ veiculo.km_para_preventiva | format_km if veiculo.km_para_preventiva is not none else '-' }}
          </td>
          <td class="{% if veiculo.km_para_intermediaria is not none and veiculo.km_para_intermediaria <= 5000 %}alerta{% endif %}">
            {{ veiculo.km_para_intermediaria | format_km if veiculo.km_para_intermediaria is not none else '-' }}
          </td>
          <td class="{% if veiculo.km_para_diferencial is not none and veiculo.km_para_diferencial <= 5000 %}alerta{% endif %}">
            {{ veiculo.km_para_diferencial | format_km if veiculo.km_para_diferencial is not none else '-' }}
          </td>
          <td class="{% if veiculo.km_para_cambio is not none and veiculo.km_para_cambio <= 5000 %}alerta{% endif %}">
            {{ veiculo.km_para_cambio | format_km if veiculo.km_para_cambio is not none else '-' }}
          </td>
         <!-- <td class="{% if veiculo.data_proxima_calibragem and veiculo.data_proxima_calibragem <= current_date %}alerta{% endif %}">
            {{ veiculo.data_proxima_calibragem.strftime('%d/%m/%Y') if veiculo.data_proxima_calibragem else '-' }}
          </td> -->
          <td>{{ veiculo.unidade }}</td>
          <td>
            {% if current_user.tipo.upper() == 'MASTER' %}
              <button class="btn btn-warning btn-sm" onclick="alternarManutencao('{{ veiculo.placa }}')">‚öôÔ∏è Em Manuten√ß√£o</button>
            {% endif %}
            <button onclick="window.location.href='{{ url_for('main.realizar_manutencao', placa_pre_selecionada=veiculo.placa) }}'" class="btn btn-info btn-sm" style="margin-left: 5px;">
              + Nova Manuten√ß√£o
            </button>
          </td>
        </tr>

        {% if veiculo.manutencoes_vencidas %}
          <tr class="linha-bloqueio">
            <td colspan="13">
              <div class="alerta-bloqueio">
                üö´ <strong>VE√çCULO BLOQUEADO</strong>: Manuten√ß√£o vencida ‚Äî {{ veiculo.manutencoes_vencidas | join(', ') }}.
                <br>Este ve√≠culo <strong>n√£o deve entrar em opera√ß√£o</strong> at√© que a manuten√ß√£o seja realizada.
              </div>
            </td>
          </tr>
        {% endif %}

        {% if veiculo.em_manutencao %}
          <tr>
            <td colspan="13" style="position: relative;">
              <div class="texto-corrente">
                <img src="/static/guincho.png" alt="Guincho" class="guincho-frontal">
                <img src="/static/carro-sem-fundo.png" alt="Carro em manuten√ß√£o" class="guincho-frontal">
                <span>üöß VE√çCULO EM MANUTEN√á√ÉO</span>
              </div>
            </td>
          </tr>
        {% endif %}
      {% else %}
        <tr><td colspan="13">Nenhum ve√≠culo com manuten√ß√£o pr√≥xima.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  function alternarManutencao(placa) {
    const token = document.getElementById("csrf_token").value;
    fetch(`/manutencao/${placa}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': token
      },
      body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'ok') {
        location.reload();
      }
    });
  }
</script>

<style>
  .linha-bloqueio {
    background-color: #ff4d4d;
    color: white;
    font-weight: bold;
    animation: piscar 1s infinite;
  }

  @keyframes piscar {
    0% { background-color: #ff4d4d; }
    50% { background-color: #ff9999; }
    100% { background-color: #ff4d4d; }
  }

  .alerta-bloqueio {
    padding: 10px;
    font-size: 1.1em;
    text-align: center;
  }
</style>
{% endblock %}
