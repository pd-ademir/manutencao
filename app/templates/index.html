{% extends 'base.html' %}
{% block titulo %}Painel de Manuten√ß√£o{% endblock %}

{% block conteudo %}
<h1>Painel de Manuten√ß√£o</h1>

<input type="hidden" id="csrf_token" value="{{ csrf_token() }}">
<form method="get" action="{{ url_for('main.index') }}">
  {% if request.args.get('filtro') == 'ocultar_somente_calibragem' %}
    <button class="btn btn-secondary" style="margin-bottom: 15px;">
      üîÑ Mostrar todos os ve√≠culos
    </button>
  {% else %}
    <input type="hidden" name="filtro" value="ocultar_somente_calibragem">
    <button class="btn btn-secondary" style="margin-bottom: 15px;">
      üö´ Ocultar ve√≠culos com apenas calibragem vencida
    </button>
  {% endif %}
</form>

{% if current_user.is_authenticated and current_user.tipo.upper() == 'MASTER' %}
  <form action="{{ url_for('main.teste_alerta') }}" method="get">
    <button class="btn btn-danger" style="margin-bottom: 15px; background: #28a745">
      üîî Disparar Alertas de Manuten√ß√£o
    </button>
  </form>
{% endif %}

<p>Confira abaixo os ve√≠culos com revis√µes pr√≥ximas do vencimento.</p>

<div class="tabela-scroll">
  <table class="tabela-index">
    <thead>
      <tr>
        <th>Placa Cavalo</th>
        <th>Engate 1</th>
        <th>Engate 2</th>
        <th>Motorista</th>
        <th>Modelo</th>
        <th>KM Atual</th>
        <th>Pr√≥x. Preventiva</th>
        <th>Pr√≥x. Intermedi√°ria</th>
        <th>Pr√≥x. Diferencial</th>
        <th>Pr√≥x. C√¢mbio</th>
        <th>Pr√≥x. Calibragem</th>
        <th>Unidade</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody>
      {% for veiculo in veiculos %}
        <!-- Linha do ve√≠culo (sem altera√ß√µes) -->
        <tr data-placa="{{ veiculo.placa }}" class="{% if veiculo.em_manutencao %}linha-manutencao{% endif %}">
            <td>
                {% if veiculo.data_proxima_revisao_carreta %}{% set dias_para_revisao = (veiculo.data_proxima_revisao_carreta - current_date).days %}{% if dias_para_revisao < 0 %}<span class="badge bg-danger" title="Revis√£o atrasada em {{ -dias_para_revisao }} dias">üî¥</span>{% elif dias_para_revisao <= 30 %}<span class="badge bg-warning text-dark" title="Revis√£o em {{ dias_para_revisao }} dias">üü°</span>{% endif %}{% endif %}
                <a href="{{ url_for('checklist.por_placa', placa=veiculo.placa) }}" class="link-primary text-decoration-none" title="Pr√≥xima revis√£o da carreta: {{ veiculo.data_proxima_revisao_carreta.strftime('%d/%m/%Y') if veiculo.data_proxima_revisao_carreta else 'Sem previs√£o' }}">{{ veiculo.placa }}</a>
            </td>
            <td>{{ veiculo.placa_1 or '-' }}</td>
            <td>{{ veiculo.placa_2 or '-' }}</td>
            <td>{{ veiculo.motorista }}</td>
            <td>{{ veiculo.modelo }}</td>
            <td title="Atualizado em: {{ veiculo.data_ultima_atualizacao_km.strftime('%d/%m/%Y %H:%M') if veiculo.data_ultima_atualizacao_km else 'Sem registro' }}">{{ veiculo.km_atual | format_km }}</td>
            <td class="{% if veiculo.km_para_preventiva is not none and veiculo.km_para_preventiva <= 5000 %}alerta{% endif %}">{{ veiculo.km_para_preventiva | format_km if veiculo.km_para_preventiva is not none else '-' }}</td>
            <td class="{% if veiculo.km_para_intermediaria is not none and veiculo.km_para_intermediaria <= 5000 %}alerta{% endif %}">{{ veiculo.km_para_intermediaria | format_km if veiculo.km_para_intermediaria is not none else '-' }}</td>
            <td class="{% if veiculo.km_para_diferencial is not none and veiculo.km_para_diferencial <= 5000 %}alerta{% endif %}">{{ veiculo.km_para_diferencial | format_km if veiculo.km_para_diferencial is not none else '-' }}</td>
            <td class="{% if veiculo.km_para_cambio is not none and veiculo.km_para_cambio <= 5000 %}alerta{% endif %}">{{ veiculo.km_para_cambio | format_km if veiculo.km_para_cambio is not none else '-' }}</td>
            <td class="{% if veiculo.data_proxima_calibragem and veiculo.data_proxima_calibragem <= current_date %}alerta{% endif %}">{{ veiculo.data_proxima_calibragem.strftime('%d/%m/%Y') if veiculo.data_proxima_calibragem else '-' }}</td>
            <td>{{ veiculo.unidade }}</td>
            <td>
                {% if current_user.tipo.upper() == 'MASTER' %}<button class="btn btn-warning btn-sm" onclick="alternarManutencao('{{ veiculo.placa }}')">‚öôÔ∏è Em Manuten√ß√£o</button>{% endif %}
                <button onclick="window.location.href='{{ url_for('main.realizar_manutencao', placa_pre_selecionada=veiculo.placa) }}'" class="btn btn-info btn-sm" style="margin-left: 5px;">+ Nova Manuten√ß√£o</button>
            </td>
        </tr>

        <!-- Bloco de Alerta de Agendamento -->
        {% set manutencoes_proximas = [] %}
        {% if veiculo.km_para_preventiva is not none and 0 < veiculo.km_para_preventiva <= 1000 %}{% set _ = manutencoes_proximas.append(1) %}{% endif %}
        {% if veiculo.km_para_intermediaria is not none and 0 < veiculo.km_para_intermediaria <= 1000 %}{% set _ = manutencoes_proximas.append(1) %}{% endif %}
        {% if veiculo.km_para_diferencial is not none and 0 < veiculo.km_para_diferencial <= 1000 %}{% set _ = manutencoes_proximas.append(1) %}{% endif %}
        {% if veiculo.km_para_cambio is not none and 0 < veiculo.km_para_cambio <= 1000 %}{% set _ = manutencoes_proximas.append(1) %}{% endif %}

        {% if manutencoes_proximas %}
            <tr class="linha-alerta-agendamento" id="alerta-agendamento-{{ veiculo.placa }}">
                <td colspan="13">
                    <div class="card-alerta-agendamento">
                        <!-- IN√çCIO DA MODIFICA√á√ÉO: Novo formato de texto -->
                        <div class="card-texto" style="font-family: monospace; line-height: 1.6;">
                            <strong>- SEGUE PLACAS QUE PRECISAM FAZER MANUTEN√á√ÉO.</strong><br><br>
                            {% if veiculo.km_para_preventiva is not none and 0 < veiculo.km_para_preventiva <= 1000 %}
                                <strong>{{ veiculo.unidade }} - MOTORISTA, {{ veiculo.motorista or 'N/A' }} ‚Äì {{ veiculo.placa }}{% if veiculo.placa_1 %}, {{ veiculo.placa_1 }}{% endif %}{% if veiculo.placa_2 %}, {{ veiculo.placa_2 }}{% endif %} ‚Äì FALTA {{ veiculo.km_para_preventiva | format_km }} PARA A PREVENTIVA</strong><br>
                            {% endif %}
                            {% if veiculo.km_para_intermediaria is not none and 0 < veiculo.km_para_intermediaria <= 1000 %}
                                <strong>{{ veiculo.unidade }} - MOTORISTA, {{ veiculo.motorista or 'N/A' }} ‚Äì {{ veiculo.placa }}{% if veiculo.placa_1 %}, {{ veiculo.placa_1 }}{% endif %}{% if veiculo.placa_2 %}, {{ veiculo.placa_2 }}{% endif %} ‚Äì FALTA {{ veiculo.km_para_intermediaria | format_km }} PARA A INTERMEDI√ÅRIA</strong><br>
                            {% endif %}
                            {% if veiculo.km_para_diferencial is not none and 0 < veiculo.km_para_diferencial <= 1000 %}
                                <strong>{{ veiculo.unidade }} - MOTORISTA, {{ veiculo.motorista or 'N/A' }} ‚Äì {{ veiculo.placa }}{% if veiculo.placa_1 %}, {{ veiculo.placa_1 }}{% endif %}{% if veiculo.placa_2 %}, {{ veiculo.placa_2 }}{% endif %} ‚Äì FALTA {{ veiculo.km_para_diferencial | format_km }} PARA O DIFERENCIAL</strong><br>
                            {% endif %}
                            {% if veiculo.km_para_cambio is not none and 0 < veiculo.km_para_cambio <= 1000 %}
                                <strong>{{ veiculo.unidade }} - MOTORISTA, {{ veiculo.motorista or 'N/A' }} ‚Äì {{ veiculo.placa }}{% if veiculo.placa_1 %}, {{ veiculo.placa_1 }}{% endif %}{% if veiculo.placa_2 %}, {{ veiculo.placa_2 }}{% endif %} ‚Äì FALTA {{ veiculo.km_para_cambio | format_km }} PARA O C√ÇMBIO</strong><br>
                            {% endif %}
                        </div>
                        <!-- FIM DA MODIFICA√á√ÉO -->

                        <div class="card-botoes">
                            <!-- IN√çCIO DA MODIFICA√á√ÉO: O link agora aponta para a p√°gina principal do Gmail -->
                            <a href="https://mail.google.com/" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               class="btn-email">
                                üìß Abrir Gmail
                            </a>
                            <!-- FIM DA MODIFICA√á√ÉO -->
                            <button onclick="ocultarAlertaAgendamento('{{ veiculo.placa }}')" class="btn-ocultar">
                                ‚úï Ocultar Alerta
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
        {% endif %}

        <!-- Linhas de bloqueio e manuten√ß√£o (sem altera√ß√µes) -->
        {% if veiculo.manutencoes_vencidas %}<tr class="linha-bloqueio"><td colspan="13"><div class="alerta-bloqueio">üö´ <strong>VE√çCULO BLOQUEADO</strong>: Manuten√ß√£o vencida ‚Äî {{ veiculo.manutencoes_vencidas | join(', ') }}.<br>Este ve√≠culo <strong>n√£o deve entrar em opera√ß√£o</strong> at√© que a manuten√ß√£o seja realizada.</div></td></tr>{% endif %}
        {% if veiculo.em_manutencao %}<tr><td colspan="13" style="position: relative;"><div class="texto-corrente"><img src="/static/guincho.png" alt="Guincho" class="guincho-frontal"><img src="/static/carro-sem-fundo.png" alt="Carro em manuten√ß√£o" class="guincho-frontal"><span>üöß VE√çCULO EM MANUTEN√á√ÉO</span></div></td></tr>{% endif %}
      {% else %}
        <tr><td colspan="13">Nenhum ve√≠culo com manuten√ß√£o pr√≥xima.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const alertas = document.querySelectorAll('.linha-alerta-agendamento');
    alertas.forEach(alerta => {
        const placa = alerta.id.replace('alerta-agendamento-', '');
        if (localStorage.getItem('alerta_agendamento_oculto_' + placa)) {
            alerta.style.display = 'none';
        }
    });
});
function ocultarAlertaAgendamento(placa) {
    localStorage.setItem('alerta_agendamento_oculto_' + placa, 'true');
    const alertaParaOcultar = document.getElementById('alerta-agendamento-' + placa);
    if (alertaParaOcultar) {
        alertaParaOcultar.style.display = 'none';
    }
}
</script>

<style>
.card-alerta-agendamento { background-color: #fff3cd; border-left: 5px solid #ffc107; color: #856404; padding: 15px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
.card-texto { flex-grow: 1; }
.card-botoes { display: flex; gap: 10px; align-items: center; }
.btn-email { background-color: #007bff; color: white; padding: 8px 12px; border-radius: 4px; text-decoration: none; font-size: 14px; white-space: nowrap; }
.btn-ocultar { background: none; border: none; font-size: 20px; cursor: pointer; color: #856404; }
.linha-bloqueio { background-color: #ff4d4d; color: white; font-weight: bold; animation: piscar 1s infinite; }
@keyframes piscar { 0% { background-color: #ff4d4d; } 50% { background-color: #ff9999; } 100% { background-color: #ff4d4d; } }
.alerta-bloqueio { padding: 10px; font-size: 1.1em; text-align: center; }
</style>

{% endblock %}
